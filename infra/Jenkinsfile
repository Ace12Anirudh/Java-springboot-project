pipeline {
  agent any
  environment {
    AWS_REGION = 'us-east-1'
    AWS_CRED_ID = 'aws-creds'
    SSH_KEY_CRED = 'jenkins-ssh-key'
    SONAR_TOKEN = credentials('sonar-token')
    JENKINS_SSH_USER = 'ec2-user'   // default Amazon Linux user for initial scp; we use sudo in commands
    REMOTE_APP_USER = 'appuser'     // user created by user-data; systemd runs under this user
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Sonar - Frontend') {
      steps {
        dir('frontend') {
          sh '''
            # run sonar-scanner for python (ensure sonar-scanner is available on agent)
            sonar-scanner -Dsonar.projectKey=student-management-frontend \
              -Dsonar.sources=src \
              -Dsonar.login=${SONAR_TOKEN} || true
          '''
        }
      }
    }

    stage('Build Frontend artifact') {
      steps {
        dir('frontend') {
          sh '''
            # package the frontend src directory as zip
            rm -f ../frontend-artifact.zip
            zip -r ../frontend-artifact.zip src requirements.txt || true
          '''
        }
        stash includes: 'frontend-artifact.zip', name: 'frontend-artifact'
      }
    }

    stage('Sonar - Backend') {
      steps {
        dir('backend') {
          sh "/opt/maven/bin/mvn -B -DskipTests clean package sonar:sonar -Dsonar.login=${SONAR_TOKEN} || true"
        }
      }
    }

    stage('Build Backend artifact') {
      steps {
        dir('backend') {
          sh '''
            /opt/maven/bin/mvn -B -DskipTests clean package
            cp target/*.jar ../backend.jar || true
            cd ..
            zip -j backend-artifact.zip backend.jar || true
          '''
        }
        stash includes: 'backend-artifact.zip', name: 'backend-artifact'
      }
    }

    // stage('Terraform Init & Apply') {
    //   steps {
    //     withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CRED_ID]]) {
    //       dir('infra') {
    //         sh '''
    //           terraform init -input=false
    //           terraform plan -out=tfplan -input=false
    //           terraform apply -input=false -auto-approve tfplan
    //         '''
    //       }
    //     }
    //   }
    // }

    stage('Discover Instances & Deploy via SSH') {
      steps {
        unstash 'frontend-artifact'
        unstash 'backend-artifact'
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: AWS_CRED_ID],
          [$class: 'SSHUserPrivateKeyBinding', credentialsId: SSH_KEY_CRED, keyFileVariable: 'SSH_KEY_FILE']
        ]) {
          sh '''
            set -ex
            cd infra
            
            # Validate Terraform outputs exist
            echo "=== Retrieving Terraform Outputs ==="
            FRONT_ASG_NAME=$(terraform output -raw frontend_asg_name 2>/dev/null || echo "")
            BACK_ASG_NAME=$(terraform output -raw backend_asg_name 2>/dev/null || echo "")
            BASTION_IP=$(terraform output -raw bastion_public_ip 2>/dev/null || echo "")
            RDS_ENDPOINT=$(terraform output -raw rds_endpoint 2>/dev/null || echo "")
            
            if [ -z "$FRONT_ASG_NAME" ] || [ -z "$BACK_ASG_NAME" ] || [ -z "$BASTION_IP" ]; then
              echo "ERROR: Missing required Terraform outputs!"
              echo "Frontend ASG: $FRONT_ASG_NAME"
              echo "Backend ASG: $BACK_ASG_NAME"
              echo "Bastion IP: $BASTION_IP"
              exit 1
            fi
            
            echo "Frontend ASG Name: $FRONT_ASG_NAME"
            echo "Backend ASG Name: $BACK_ASG_NAME"
            echo "Bastion Public IP: $BASTION_IP"
            echo "RDS Endpoint: $RDS_ENDPOINT"

            # Get instance IDs from Auto Scaling Groups
            echo "=== Discovering EC2 Instances ==="
            FRONT_INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names $FRONT_ASG_NAME \
              --region ${AWS_REGION} \
              --query "AutoScalingGroups[0].Instances[?LifecycleState=='InService'].InstanceId" \
              --output text 2>/dev/null || echo "")
            
            BACK_INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names $BACK_ASG_NAME \
              --region ${AWS_REGION} \
              --query "AutoScalingGroups[0].Instances[?LifecycleState=='InService'].InstanceId" \
              --output text 2>/dev/null || echo "")

            echo "Frontend Instance IDs: $FRONT_INSTANCE_IDS"
            echo "Backend Instance IDs: $BACK_INSTANCE_IDS"

            # Function to get private IPs from instance IDs
            get_ips() {
              ids="$1"
              if [ -z "$ids" ]; then 
                echo ""
                return
              fi
              aws ec2 describe-instances \
                --instance-ids $ids \
                --region ${AWS_REGION} \
                --query "Reservations[].Instances[].PrivateIpAddress" \
                --output text 2>/dev/null || echo ""
            }

            FRONT_IPS=$(get_ips "$FRONT_INSTANCE_IDS")
            BACK_IPS=$(get_ips "$BACK_INSTANCE_IDS")

            echo "=== Instance Private IPs ==="
            echo "Frontend IPs: $FRONT_IPS"
            echo "Backend IPs: $BACK_IPS"
            
            if [ -z "$FRONT_IPS" ]; then
              echo "WARNING: No frontend instances found or not yet InService"
            fi
            
            if [ -z "$BACK_IPS" ]; then
              echo "WARNING: No backend instances found or not yet InService"
            fi

            # Prepare artifacts
            cd ..
            mkdir -p deploy
            
            if [ -f frontend-artifact.zip ]; then
              mv frontend-artifact.zip deploy/
              echo "Frontend artifact prepared"
            else
              echo "ERROR: frontend-artifact.zip not found!"
              exit 1
            fi
            
            if [ -f backend-artifact.zip ]; then
              mv backend-artifact.zip deploy/
              echo "Backend artifact prepared"
            else
              echo "ERROR: backend-artifact.zip not found!"
              exit 1
            fi

            # Set SSH options
            SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ServerAliveInterval=60"
            PROXY_CMD="ssh -i $SSH_KEY_FILE -W %h:%p $SSH_OPTS ec2-user@${BASTION_IP}"

            # Deploy to frontend instances
            echo "=== Deploying Frontend ==="
            for ip in $FRONT_IPS; do
              echo "Deploying frontend to ${ip} via bastion ${BASTION_IP}"
              
              # Copy artifact
              scp $SSH_OPTS -i $SSH_KEY_FILE -o ProxyCommand="$PROXY_CMD" \
                deploy/frontend-artifact.zip ec2-user@${ip}:/tmp/ || {
                echo "WARNING: Failed to copy frontend artifact to $ip"
                continue
              }
              
              # Deploy and restart service
              ssh $SSH_OPTS -i $SSH_KEY_FILE -o ProxyCommand="$PROXY_CMD" ec2-user@${ip} \
                "sudo mkdir -p /opt/frontend && \
                 sudo unzip -o /tmp/frontend-artifact.zip -d /opt/frontend && \
                 sudo chown -R appuser:appuser /opt/frontend && \
                 sudo -u appuser /opt/frontend/.venv/bin/pip install -r /opt/frontend/requirements.txt 2>/dev/null || true && \
                 sudo systemctl restart frontend.service && \
                 sudo systemctl status frontend.service --no-pager" || {
                echo "WARNING: Failed to deploy frontend to $ip"
                continue
              }
              
              echo "✓ Frontend deployed successfully to $ip"
            done

            # Deploy to backend instances
            echo "=== Deploying Backend ==="
            for ip in $BACK_IPS; do
              echo "Deploying backend to ${ip} via bastion ${BASTION_IP}"
              
              # Copy artifact
              scp $SSH_OPTS -i $SSH_KEY_FILE -o ProxyCommand="$PROXY_CMD" \
                deploy/backend-artifact.zip ec2-user@${ip}:/tmp/ || {
                echo "WARNING: Failed to copy backend artifact to $ip"
                continue
              }
              
              # Deploy and restart service
              ssh $SSH_OPTS -i $SSH_KEY_FILE -o ProxyCommand="$PROXY_CMD" ec2-user@${ip} \
                "sudo mkdir -p /opt/backend && \
                 sudo unzip -o /tmp/backend-artifact.zip -d /opt/backend && \
                 sudo chown -R appuser:appuser /opt/backend && \
                 sudo systemctl restart backend.service && \
                 sudo systemctl status backend.service --no-pager" || {
                echo "WARNING: Failed to deploy backend to $ip"
                continue
              }
              
              echo "✓ Backend deployed successfully to $ip"
            done
            
            echo "=== Deployment Complete ==="
          '''
        }
      }
    }

  }

  post {
    always {
      cleanWs()
    }
  }
}
